---
# Kerberos KDC role - Main tasks

- name: Install Kerberos KDC packages
  ansible.builtin.apt:
    name: "{{ kdc_packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600
  tags:
    - kdc
    - packages

- name: Template Kerberos client configuration
  ansible.builtin.template:
    src: krb5.conf.j2
    dest: /etc/krb5.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - kdc
    - config

- name: Template KDC configuration
  ansible.builtin.template:
    src: kdc.conf.j2
    dest: /etc/krb5kdc/kdc.conf
    owner: root
    group: root
    mode: '0600'
  notify: restart krb5-kdc
  tags:
    - kdc
    - config

- name: Template kadmin ACL configuration
  ansible.builtin.template:
    src: kadm5.acl.j2
    dest: /etc/krb5kdc/kadm5.acl
    owner: root
    group: root
    mode: '0600'
  notify: restart krb5-admin-server
  tags:
    - kdc
    - config

- name: Check if Kerberos database exists
  ansible.builtin.stat:
    path: /var/lib/krb5kdc/principal
  register: kdc_database
  tags:
    - kdc
    - database

- name: Create Kerberos database
  ansible.builtin.shell: |
    printf "{{ kdc_master_password }}\n{{ kdc_master_password }}\n" | KRB5_CONFIG=/etc/krb5.conf kdb5_util -r {{ kdc_realm }} create -s
  when: not kdc_database.stat.exists
  no_log: true
  tags:
    - kdc
    - database

- name: Check if admin principal exists
  ansible.builtin.shell: |
    kadmin.local -q "getprinc {{ kdc_admin_principal }}@{{ kdc_realm }}" 2>&1 | grep -q "Principal does not exist"
  register: admin_principal_check
  changed_when: false
  failed_when: false
  tags:
    - kdc
    - principals

- name: Create admin principal
  ansible.builtin.shell: |
    kadmin.local -q "addprinc -pw {{ kdc_admin_password }} {{ kdc_admin_principal }}@{{ kdc_realm }}"
  when: admin_principal_check.rc == 0
  no_log: true
  tags:
    - kdc
    - principals

- name: Create keytab export directory
  ansible.builtin.file:
    path: "{{ kdc_keytab_export_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'
  tags:
    - kdc
    - keytabs

- name: Create service principals
  ansible.builtin.shell: |
    kadmin.local -q "addprinc -randkey {{ item }}"
  loop: "{{ kdc_service_principals }}"
  when: kdc_service_principals | length > 0
  register: service_principal_creation
  changed_when: "'Principal or policy already exists' not in service_principal_creation.stderr"
  failed_when: 
    - service_principal_creation.rc != 0
    - "'Principal or policy already exists' not in service_principal_creation.stderr"
  tags:
    - kdc
    - principals
    - services

- name: Export service principal keytabs
  ansible.builtin.shell: |
    principal_name="{{ item }}"
    safe_name=$(echo "$principal_name" | tr '/@' '_')
    kadmin.local -q "ktadd -k {{ kdc_keytab_export_dir }}/${safe_name}.keytab {{ item }}"
  loop: "{{ kdc_service_principals }}"
  when: kdc_service_principals | length > 0
  tags:
    - kdc
    - keytabs
    - services

- name: Create user principals
  ansible.builtin.shell: |
    kadmin.local -q "addprinc -pw {{ item.password }} {{ item.name }}@{{ kdc_realm }}"
  loop: "{{ kdc_user_principals }}"
  when: kdc_user_principals | length > 0
  no_log: true
  register: user_principal_creation
  changed_when: "'Principal or policy already exists' not in user_principal_creation.stderr"
  failed_when:
    - user_principal_creation.rc != 0
    - "'Principal or policy already exists' not in user_principal_creation.stderr"
  tags:
    - kdc
    - principals
    - users

- name: Create OS users for Kerberos principals
  ansible.builtin.user:
    name: "{{ item.name }}"
    comment: "{{ item.comment | default('Kerberos user ' + item.name) }}"
    group: "{{ item.group | default('users') }}"
    groups: "{{ item.groups | default([]) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    create_home: "{{ item.create_home | default(true) }}"
    state: present
  loop: "{{ kdc_user_principals }}"
  when: 
    - kdc_user_principals | length > 0
    - kdc_create_os_users | default(true) | bool
  tags:
    - kdc
    - users
    - os-users

- name: Ensure users group exists
  ansible.builtin.group:
    name: users
    state: present
  when: kdc_create_os_users | default(true) | bool
  tags:
    - kdc
    - users
    - os-users

- name: Check if Samba is configured
  ansible.builtin.stat:
    path: /etc/samba/smb.conf
  register: samba_config
  tags:
    - kdc
    - users
    - samba-passwords

- name: Create Samba passwords for users
  ansible.builtin.shell: |
    (echo '{{ item.password }}'; echo '{{ item.password }}') | smbpasswd -s -a {{ item.name }}
  loop: "{{ kdc_user_principals }}"
  when: 
    - kdc_user_principals | length > 0
    - kdc_create_os_users | default(true) | bool
    - kdc_create_samba_passwords | default(true) | bool
    - samba_config.stat.exists
  no_log: true
  register: samba_password_creation
  changed_when: "'Added user' in samba_password_creation.stdout or 'Password changed' in samba_password_creation.stdout"
  failed_when:
    - samba_password_creation.rc != 0
    - "'Unable to find user' not in samba_password_creation.stderr"
  tags:
    - kdc
    - users
    - samba-passwords

- name: Samba passwords skipped (Samba not configured)
  ansible.builtin.debug:
    msg: "Samba passwords not created - /etc/samba/smb.conf does not exist. Run site.yml to configure Samba first."
  when:
    - kdc_create_samba_passwords | default(true) | bool
    - not samba_config.stat.exists
  tags:
    - kdc
    - users
    - samba-passwords

- name: Enable krb5-kdc service
  ansible.builtin.systemd:
    name: krb5-kdc
    enabled: true
    daemon_reload: true
  tags:
    - kdc
    - services

- name: Enable krb5-admin-server service
  ansible.builtin.systemd:
    name: krb5-admin-server
    enabled: true
  tags:
    - kdc
    - services

- name: Start krb5-kdc service
  ansible.builtin.systemd:
    name: krb5-kdc
    state: started
  tags:
    - kdc
    - services

- name: Start krb5-admin-server service
  ansible.builtin.systemd:
    name: krb5-admin-server
    state: started
  tags:
    - kdc
    - services

- name: Display KDC information
  ansible.builtin.debug:
    msg: |
      ========================================
      Kerberos KDC Configuration Complete
      ========================================
      Realm: {{ kdc_realm }}
      KDC Server: {{ ansible_fqdn }}
      Admin Server: {{ ansible_fqdn }}
      
      Admin Principal: {{ kdc_admin_principal }}@{{ kdc_realm }}
      
      Service Principals Created: {{ kdc_service_principals | length }}
      User Principals Created: {{ kdc_user_principals | length }}
      
      Keytabs exported to: {{ kdc_keytab_export_dir }}
      
      To manage principals:
        kadmin.local
      
      To test authentication:
        kinit {{ kdc_admin_principal }}@{{ kdc_realm }}
      ========================================
  tags:
    - kdc
